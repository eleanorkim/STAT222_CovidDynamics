---
title: "Spatial Dynamics - Modeling"
subtitle: "Aarushi Somani, Eleanor Kim, Lauren Murai, Meichen Chen"
output:
  pdf_document: default
  html_document: default
date: '2024-03-11'
---

```{r}
#load packages
library(sandwich)
library(lmtest)
library(dplyr)
```

```{r}
# Weekly Spatial Metrics with Time Wave Columns
weekly_spatial_metrics_waves = read.csv("weekly_spatial_metrics_waves.csv")
names(weekly_spatial_metrics_waves)
```
Output: weekly_spatial_metrics_waves
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 160 rows (weeks 6 - 165) x 57 columns (date, cases, cor length, C(r), wave dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, wave, wave 1 dummy, wave 2 dummy


```{r}
# Weekly Spatial Metrics with Region Columns
regional_weekly_spatial_metrics = read.csv("regional_weekly_spatial_metrics.csv")
regional_weekly_spatial_metrics$northeast[regional_weekly_spatial_metrics$region == 'Northeast'] <- 1
regional_weekly_spatial_metrics$midwest[regional_weekly_spatial_metrics$region == 'Midwest'] <- 1
regional_weekly_spatial_metrics$south[regional_weekly_spatial_metrics$region == 'South'] <- 1
regional_weekly_spatial_metrics
```
Output: regional_weekly_spatial_metrics
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 640 rows (weeks 6 - 165 x 4 regions) x 59 columns (date, cases, cor length, C(r), region dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, region, northeast dummy, midwest dummy, south dummy



```{r}
# Weekly Spatial Metrics with Poverty Columns
poverty_weekly_spatial_metrics = read.csv("poverty_weekly_spatial_metrics.csv")
names(poverty_weekly_spatial_metrics)
```
Output: poverty_weekly_spatial_metrics
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 960 rows (weeks 6 - 165 x 6 poverty tiers) x 61 columns (date, cases, cor length, C(r), poverty dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, pov tier (1,1) dummy, pov tier (2,2) dummy, pov tier (3,3) dummy, pov tier (1,2) dummy, pov tier (1,3) dummy, pov tier (2,3) dummy

# Model on entire data

```{r}
# Regress next week's marginal cases on correlation length
simple_model <- lm(log(weekly_spatial_metrics_waves$next_week_marginal_cases) ~ log(weekly_spatial_metrics_waves$cor_lengths), data = weekly_spatial_metrics_waves)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(simple_model, type = "HC1")))

robust_test <- coeftest(simple_model, vcov = vcovHC(simple_model, type = "HC1"))
print(robust_test)

# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

# Model based on poverty tiers  

```{r}
# full model 
full_pov_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + pov_tier_1 + pov_tier_2, data = poverty_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(full_pov_model, type = "HC1")))

robust_test <- coeftest(full_pov_model, vcov = vcovHC(full_pov_model, type = "HC1"))
print(robust_test)
```

```{r}
# split into a "simple model" for subsetted data 

# simple model for poverty tier (1,1)
pov_11_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_11 == 1)

pov_11_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_11_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_11_simple_model, type = "HC1")))

robust_test <- coeftest(pov_11_simple_model, vcov = vcovHC(pov_11_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_11_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for poverty tier (2,2)
pov_22_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_22 == 1)

pov_22_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_22_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_22_simple_model, type = "HC1")))

robust_test <- coeftest(pov_22_simple_model, vcov = vcovHC(pov_22_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_22_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for poverty tier (3,3)
pov_33_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_33 == 1)

pov_33_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_33_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_33_simple_model, type = "HC1")))

robust_test <- coeftest(pov_33_simple_model, vcov = vcovHC(pov_33_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_33_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for poverty tier (1,2)
pov_12_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_12 == 1)

pov_12_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_12_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_12_simple_model, type = "HC1")))

robust_test <- coeftest(pov_12_simple_model, vcov = vcovHC(pov_12_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_12_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for poverty tier (1,3)
pov_13_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_13 == 1)

pov_13_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_13_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_13_simple_model, type = "HC1")))

robust_test <- coeftest(pov_13_simple_model, vcov = vcovHC(pov_13_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_13_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for poverty tier (2,3)
pov_23_weekly_spatial_metrics <- poverty_weekly_spatial_metrics %>% filter(tier_23 == 1)

pov_23_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = pov_23_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(pov_23_simple_model, type = "HC1")))

robust_test <- coeftest(pov_23_simple_model, vcov = vcovHC(pov_23_simple_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(pov_23_simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

# Model based on regions

```{r}
# full model without interactions
region_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + northeast + midwest + south, data = regional_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(region_model, type = "HC1")))

robust_test <- coeftest(region_model, vcov = vcovHC(region_model, type = "HC1"))
print(robust_test)

# full model with interactions
region_model_int <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + northeast + northeast*log(cor_lengths) + midwest + midwest*log(cor_lengths) + south + south*log(cor_lengths), data = regional_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se_int <- sqrt(diag(vcovHC(region_model_int, type = "HC1")))

robust_test_int <- coeftest(region_model_int, vcov = vcovHC(region_model_int, type = "HC1"))
print(robust_test_int)
```
# Split into a "simple model" for subsetted data 

```{r}
# simple model for northeast
ne_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(northeast == 1)

northeast_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = ne_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(northeast_model, type = "HC1")))

robust_test <- coeftest(northeast_model, vcov = vcovHC(northeast_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the Northeast region corresponds to a ", round(northeast_model$coefficients[2]*10,2),"% change in cases in the following week")
```
```{r}
# simple model for midwest
mw_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(midwest == 1)

midwest_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = mw_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(midwest_model, type = "HC1")))

robust_test <- coeftest(midwest_model, vcov = vcovHC(midwest_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the MidWest region corresponds to a ", round(midwest_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for south
s_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(south == 1)

south_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = s_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(south_model, type = "HC1")))

robust_test <- coeftest(south_model, vcov = vcovHC(south_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the South region corresponds to a ", round(south_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for west
w_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(region == 'West')

west_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = w_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(west_model, type = "HC1")))

robust_test <- coeftest(west_model, vcov = vcovHC(west_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the West region corresponds to a ", round(west_model$coefficients[2]*10,2),"% change in cases in the following week")
```

# Model based on time waves

```{r}
# Full Wave Model (w dummy variables)
full_wave_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + wave_1 + wave_2, data = weekly_spatial_metrics_waves)

robust_se <- sqrt(diag(vcovHC(full_wave_model, type = "HC1")))

robust_test <- coeftest(full_wave_model, vcov = vcovHC(full_wave_model, type = "HC1"))
print(robust_test)
```

```{r}
# Wave 1 Simple Model (weeks 9-47)
wave1_data <- weekly_spatial_metrics_waves %>% 
  filter(X >= 9 & X <= 47)

wave1_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave1_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave1_model, type = "HC1")))

robust_test <- coeftest(wave1_model, vcov = vcovHC(wave1_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave1_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# Wave 2 Simple Model (weeks 48-97)
wave2_data <- weekly_spatial_metrics_waves %>% 
  filter(X >= 48 & X <= 97)

wave2_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave2_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave2_model, type = "HC1")))

robust_test <- coeftest(wave2_model, vcov = vcovHC(wave2_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave2_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# Wave 3 Simple model (weeks 98-160)
wave3_data <- weekly_spatial_metrics_waves %>% filter(X >= 98 & X <= 160)  

wave3_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave3_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave3_model, type = "HC1")))

robust_test <- coeftest(wave3_model, vcov = vcovHC(wave3_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave3_model$coefficients[2]*10,2),"% change in cases in the following week")
```