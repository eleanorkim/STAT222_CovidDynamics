---
title: "Spatial Dynamics - Modeling"
subtitle: "Aarushi Somani, Eleanor Kim, Lauren Murai, Meichen Chen"
output:
  pdf_document: default
  html_document: default
date: '2024-03-11'
---

```{r}
#load packages
library(sandwich)
library(lmtest)
library(dplyr)
library(tibble)
```

```{r}
# Weekly Spatial Metrics with Time Wave Columns
weekly_spatial_metrics_waves = read.csv("weekly_spatial_metrics_waves.csv")
names(weekly_spatial_metrics_waves)
```
Output: weekly_spatial_metrics_waves
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 160 rows (weeks 6 - 165) x 57 columns (date, cases, cor length, C(r), wave dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, wave, wave 1 dummy, wave 2 dummy


```{r}
# Weekly Spatial Metrics with Region Columns
regional_weekly_spatial_metrics = read.csv("regional_weekly_spatial_metrics.csv")
regional_weekly_spatial_metrics$northeast[regional_weekly_spatial_metrics$region == 'Northeast'] <- 1
regional_weekly_spatial_metrics$midwest[regional_weekly_spatial_metrics$region == 'Midwest'] <- 1
regional_weekly_spatial_metrics$south[regional_weekly_spatial_metrics$region == 'South'] <- 1
regional_weekly_spatial_metrics
```
Output: regional_weekly_spatial_metrics
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 640 rows (weeks 6 - 165 x 4 regions) x 59 columns (date, cases, cor length, C(r), region dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, region, northeast dummy, midwest dummy, south dummy

```{r}
# Weekly Spatial Metrics with Poverty Columns
poverty_weekly_spatial_metrics = read.csv("poverty_weekly_spatial_metrics.csv")
names(poverty_weekly_spatial_metrics)
```
Output: poverty_weekly_spatial_metrics
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 960 rows (weeks 6 - 165 x 6 poverty tiers) x 61 columns (date, cases, cor length, C(r), poverty dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, pov tier (1,1) dummy, pov tier (2,2) dummy, pov tier (3,3) dummy, pov tier (1,2) dummy, pov tier (1,3) dummy, pov tier (2,3) dummy

```{r}
# Weekly Spatial Metrics with Median Household Income Columns
mhhinc_weekly_spatial_metrics = read.csv("mhhinc_weekly_spatial_metrics.csv")
names(mhhinc_weekly_spatial_metrics)
```
Output: mhhinc_weekly_spatial_metrics
  - Weekly data set with corresponding covid cases, spatial correlations, and correlation lengths
  - 1600 rows (weeks 6 - 165 x 10 mhhinc tiers) x 61 columns (date, cases, cor length, C(r), mhhinc dummies)
  - features: start date of week, total cases, marginal cases, next week's marginal cases, C(r) for distance intervals from [0,50] to [970,1000], correlation length, mmhinc dummies 

# Model on entire data

```{r}
# Regress next week's marginal cases on correlation length
simple_model <- lm(log(weekly_spatial_metrics_waves$next_week_marginal_cases) ~ log(weekly_spatial_metrics_waves$cor_lengths), data = weekly_spatial_metrics_waves)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(simple_model, type = "HC1")))

robust_test <- coeftest(simple_model, vcov = vcovHC(simple_model, type = "HC1"))
print(robust_test)

# Print Result
paste("a 10% increase in correlation length corresponds to a ", round(simple_model$coefficients[2]*10,2),"% change in cases in the following week")
```

# Model based on median household income

```{r}
# map factor levels to tier levels 
values <- c(1, 2, 3, 4, 6, 7, 8, 11, 12, 16)
tiers <- c("tier_1_1", "tier_1_2", "tier_1_3", "tier_1_4",
           "tier_2_2", "tier_2_3", "tier_2_4",
           "tier_3_3", "tier_3_4",
           "tier_4_4")
mhhinc_factor_tiers <- tibble(Factor = values, Tier = tiers)
print(mhhinc_factor_tiers)
```

```{r}
# full model 
full_mhhinc_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) +
                        factor(mhhinc_tier), 
                     data = mhhinc_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(full_mhhinc_model, type = "HC1")))

robust_test <- coeftest(full_mhhinc_model, vcov = vcovHC(full_mhhinc_model, type = "HC1"))
print(robust_test)
```

```{r}
# full model with interaction terms 
full_mhhinc_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) *
                        factor(mhhinc_tier), 
                     data = mhhinc_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(full_mhhinc_model, type = "HC1")))

robust_test <- coeftest(full_mhhinc_model, vcov = vcovHC(full_mhhinc_model, type = "HC1"))
print(robust_test)
```

```{r}
# split into "simple model" for subsetted data 

for(i in 1:nrow(mhhinc_factor_tiers)) {
  # Dynamic filtering based on tier
  tier_value <- mhhinc_factor_tiers$Tier[i]
  #filter_condition <- paste0(tier_value, " == 1")
  mhhinc_weekly_spatial_metrics_subset <- mhhinc_weekly_spatial_metrics %>%
    filter(!!rlang::sym(tier_value) == 1)
  
  # Linear model
  mhhinc_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                           data = mhhinc_weekly_spatial_metrics_subset)
  
  # Perform hypothesis tests with robust standard errors for heteroskedasticity
  robust_se <- sqrt(diag(vcovHC(mhhinc_simple_model, type = "HC1")))
  
  robust_test <- coeftest(mhhinc_simple_model, vcov = vcovHC(mhhinc_simple_model, type = "HC1"))
  print(robust_test)
  
  # Print result
  result <- paste("A 10% increase in correlation length corresponds to a ", 
                  round(mhhinc_simple_model$coefficients[2]*10,2),
                  "% change in cases in the following week for counties in ", tier_value, "mhhinc.")
  print(result)
}
```

# Model based on poverty tiers  

```{r}
# full model 
full_pov_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + 
                       tier_11 + tier_22 + tier_33 +tier_12 + tier_13, 
                     data = poverty_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(full_pov_model, type = "HC1")))

robust_test <- coeftest(full_pov_model, vcov = vcovHC(full_pov_model, type = "HC1"))
print(robust_test)
```

```{r}
# full model with interaction terms 
full_pov_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + 
                       tier_11  + tier_22 + tier_33 + tier_12 + tier_13 + 
                       log(cor_lengths) * tier_11 + log(cor_lengths) * tier_22 + log(cor_lengths) * tier_33 
                     + log(cor_lengths) * tier_12 + log(cor_lengths) * tier_13, 
                     data = poverty_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(full_pov_model, type = "HC1")))

robust_test <- coeftest(full_pov_model, vcov = vcovHC(full_pov_model, type = "HC1"))
print(robust_test)
```

```{r}
# split into a "simple model" for subsetted data 

# vector of tier names
pov_tiers <- c("tier_11", "tier_22", "tier_33", "tier_12", "tier_13", "tier_23")
for(tier_value in pov_tiers) {
  # Dynamic filtering based on the current tier in the loop
  pov_weekly_spatial_metrics_subset <- poverty_weekly_spatial_metrics %>%
    filter(!!rlang::sym(tier_value) == 1)
  
  # Linear model
  pov_simple_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                            data = pov_weekly_spatial_metrics_subset)
  
  # Perform hypothesis tests with robust standard errors for heteroskedasticity
  robust_test <- coeftest(pov_simple_model, vcov = vcovHC(pov_simple_model, type = "HC1"))
  print(robust_test)
  
  # Print result
  result <- paste("A 10% increase in correlation length corresponds to a ", 
                  round(pov_simple_model$coefficients[2]*10,2),
                  "% change in cases in the following week for counties in ", tier_value, "for poverty.")
  print(result)
}

```

# Model based on regions

```{r}
# full model without interactions
region_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + northeast + midwest + south, data = regional_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(region_model, type = "HC1")))

robust_test <- coeftest(region_model, vcov = vcovHC(region_model, type = "HC1"))
print(robust_test)

# full model with interactions
region_model_int <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + northeast + northeast*log(cor_lengths) + midwest + midwest*log(cor_lengths) + south + south*log(cor_lengths), data = regional_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se_int <- sqrt(diag(vcovHC(region_model_int, type = "HC1")))

robust_test_int <- coeftest(region_model_int, vcov = vcovHC(region_model_int, type = "HC1"))
print(robust_test_int)
```
# Split into a "simple model" for subsetted data 

```{r}
# simple model for northeast
ne_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(northeast == 1)

northeast_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = ne_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(northeast_model, type = "HC1")))

robust_test <- coeftest(northeast_model, vcov = vcovHC(northeast_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the Northeast region corresponds to a ", round(northeast_model$coefficients[2]*10,2),"% change in cases in the following week")
```
```{r}
# simple model for midwest
mw_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(midwest == 1)

midwest_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = mw_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(midwest_model, type = "HC1")))

robust_test <- coeftest(midwest_model, vcov = vcovHC(midwest_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the MidWest region corresponds to a ", round(midwest_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for south
s_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(south == 1)

south_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = s_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(south_model, type = "HC1")))

robust_test <- coeftest(south_model, vcov = vcovHC(south_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the South region corresponds to a ", round(south_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# simple model for west
w_weekly_spatial_metrics <- regional_weekly_spatial_metrics %>% filter(region == 'West')

west_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), 
                         data = w_weekly_spatial_metrics)
# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(west_model, type = "HC1")))

robust_test <- coeftest(west_model, vcov = vcovHC(west_model, type = "HC1"))
print(robust_test)
# Print Result
paste("a 10% increase in correlation length in the West region corresponds to a ", round(west_model$coefficients[2]*10,2),"% change in cases in the following week")
```

# Model based on time waves

```{r}
# Full Wave Model (w dummy variables)
full_wave_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths) + wave_1 + wave_2, data = weekly_spatial_metrics_waves)

robust_se <- sqrt(diag(vcovHC(full_wave_model, type = "HC1")))

robust_test <- coeftest(full_wave_model, vcov = vcovHC(full_wave_model, type = "HC1"))
print(robust_test)
```

```{r}
# Wave 1 Simple Model (weeks 9-47)
wave1_data <- weekly_spatial_metrics_waves %>% 
  filter(X >= 9 & X <= 47)

wave1_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave1_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave1_model, type = "HC1")))

robust_test <- coeftest(wave1_model, vcov = vcovHC(wave1_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave1_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# Wave 2 Simple Model (weeks 48-97)
wave2_data <- weekly_spatial_metrics_waves %>% 
  filter(X >= 48 & X <= 97)

wave2_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave2_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave2_model, type = "HC1")))

robust_test <- coeftest(wave2_model, vcov = vcovHC(wave2_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave2_model$coefficients[2]*10,2),"% change in cases in the following week")
```

```{r}
# Wave 3 Simple model (weeks 98-160)
wave3_data <- weekly_spatial_metrics_waves %>% filter(X >= 98 & X <= 160)  

wave3_model <- lm(log(next_week_marginal_cases) ~ log(cor_lengths), data = wave3_data)

# Perform hypothesis tests with robust standard errors for heteroskedasticity
robust_se <- sqrt(diag(vcovHC(wave3_model, type = "HC1")))

robust_test <- coeftest(wave3_model, vcov = vcovHC(wave3_model, type = "HC1"))
print(robust_test)

paste("a 10% increase in correlation length corresponds to a ", round(wave3_model$coefficients[2]*10,2),"% change in cases in the following week")
```
